# Building Multi-Architecture Docker Images With Buildx

> 💡 [Source page](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/)

[![](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/multi-architecture-docker.png "Multi-architecture Docker")](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/multi-architecture-docker.png)

How to create your own Docker images that run on multiple CPU architectures.

With the recent introduction of Docker’s [buildx](https://docs.docker.com/engine/reference/commandline/buildx/) functionality it becomes possible and relatively easy for everybody to build and publish Docker images that work on multiple CPU architectures. This article focuses exclusively on Linux multi-architecture docker images, shows how to go about creating such images, and what to look out for to make it work in different host environments. It’ll cover Ubuntu and Debian distributions in particular, which are used in a number of CI/CD pipelines such as Github Actions or Travis, but it’s generally applicable to other Linux distributions too. You just need to make sure to check which kernel and userspace tool versions you’ve got.

The article assumes you’re generally familiar with using Docker. If you don’t know Docker yet, you can familiarize yourself with the basics with [Docker’s Getting Started](https://docs.docker.com/get-started/) guide. Make sure you get the _Hello World_ example working before continuing here.

## [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#How-Docker-Buildx-Compiles-for-Non-Native-Architectures "How Docker Buildx Compiles for Non-Native Architectures")How Docker Buildx Compiles for Non-Native Architectures

Docker buildx multi-architecture support can make use of either native builder nodes running on different architectures or the [QEMU](https://www.qemu.org/) processor emulator. We’re only going to discuss QEMU here as it’s a pure software solution that doesn’t require you to have access to hosts that run on different CPU architectures.

QEMU works by simulating all instructions of a foreign CPU instruction set on your host processor. E.g. it can simulate ARM CPU instructions on an x86 host machine. With the QEMU simulator in place you can run foreign architecture binaries on your host. But to do so, you’d have to write every command with a prefix `qemu-<arch> <your-command>` on the command line.

Luckily, Linux also has built-in support for running non-native binaries, called [binfmt\_misc](https://en.wikipedia.org/wiki/Binfmt_misc). Whenever Linux tries to execute a binary, it checks if there is a handler for that binary format registered with binfmt\_misc. If there is, the handler is executed instead and pointed to the binary. The handler in turn executes the binary however it sees fit. An example of this is executing java byte code binaries with a JVM which interprets each java byte code. In our case we’ll make use of binfmt\_misc to transparently execute foreign CPU binaries with QEMU.

## [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Software-Requirements-for-Buildx-Non-Native-Architecture-Support "Software Requirements for Buildx Non-Native Architecture Support")Software Requirements for Buildx Non-Native Architecture Support

There are several software requirements that need to be met so docker buildx can create multi-architecture images:

-   **Docker >= 19.03**: Docker itself needs to be new enough to contain the buildx feature.
    -   **Experimental mode** for the docker CLI needs to be turned on since buildx is an experimental feature.
-   **Linux kernel >= 4.8**: The kernel side of binfmt\_misc needs to be new enough to support the fix-binary (F) flag. The fix-binary flag allows the kernel to use a binary format handler registered with binfmt\_misc inside a container or chroot even though that handler binary is not part of the file system visible inside that container or chroot.
-   **binfmt\_misc file system mounted**: The binfmt\_misc file system needs to be mounted such that userspace tools can control this kernel feature, i.e. register and enable handlers.
-   Either a **Host installation** or **Docker image based installation** of QEMU and binfmt\_misc support tools.
    -   **Host installation**:
        -   **QEMU installed**: To execute foreign CPU instructions on the host, QEMU simulators need to be installed. They need to be statically linked since dynamic library resolution depends on those dynamic libraries being visible in the file system at time of use, which is not typically the case inside a container or chroot environment.
        -   **binfmt-support package >= 2.1.7**: You need to install a package that contains an update-binfmts binary new enough to understand the fix-binary (F) flag and actually use it when registering QEMU simulators.
    -   **Docker image based installation**: You can use a Docker image that contains both QEMU binaries and setup scripts that register QEMU in binfmt\_misc similar to what the binfmt-support package does.

If you happen to run on a system that has [Docker Desktop](https://www.docker.com/products/docker-desktop) >= 2.1.0 installed, e.g. on Mac OSX or Windows, you’re in luck since it comes configured meeting all the above requirements. In this case you can [skip the rest of this section](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Building-Multi-Architecture-Docker-Images-With-Buildx). However, if you’re running on a system where Docker Desktop is not available or installed, e.g. Linux, you’ll have to install the necessary support yourself. The rest of this section assumes you’re running on Linux x86. Now let’s go through these requirements one by one.

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Docker "Docker")Docker

Docker gained buildx support with version 19.03, so you need at least this version installed. You can check your docker version with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>$</span><span> docker --version</span></span><br><span>Docker version 19.03.5, build 633a0ea838</span><br></pre></td></tr></tbody></table>

If you don’t have docker installed on your system you can try to install it from your Linux distribution’s default package sources. The package typically comes by the name of `docker-ce` or `docker.io` (see also the [table of popular Linux environments](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Status-of-Popular-Linux-Environments) below):

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></pre></td><td><pre><span><span>$</span><span> sudo apt-get install -y docker-ce</span></span><br><span>Reading package lists... Done</span><br><span>Building dependency tree       </span><br><span>Reading state information... Done</span><br><span>The following NEW packages will be installed:</span><br><span>  docker-ce</span><br><span>0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.</span><br><span>Need to get 0 B/22.8 MB of archives.</span><br><span>After this operation, 109 MB of additional disk space will be used.</span><br><span>Selecting previously unselected package docker-ce.</span><br><span>(Reading database ... 120478 files and directories currently installed.)</span><br><span>Preparing to unpack .../docker-ce_5%3a19.03.5~3-0~ubuntu-bionic_amd64.deb ..</span><br><span>Unpacking docker-ce (5:19.03.5~3-0~ubuntu-bionic) ...</span><br><span>Setting up docker-ce (5:19.03.5~3-0~ubuntu-bionic) ...</span><br><span>Processing triggers for systemd (237-3ubuntu10.33) ...</span><br><span>Processing triggers for ureadahead (0.100.0-21) ...</span><br></pre></td></tr></tbody></table>

It’s quite possible though that the docker version that comes by default with your Linux distribution is not new enough. In that case you can add Docker’s own package repository and get a newer docker version from there:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></pre></td><td><pre><span>DOCKER_APT_REPO=<span>'<a href="https://download.docker.com/linux/ubuntu" rel="nofollow"><span>https</span><span>://</span><span>download</span><span>.</span><span>docker</span><span>.</span><span>com</span><span>/</span><span>linux</span><span>/</span><span>ubuntu</span></a>'</span></span><br><span>curl -fsSL <span>"<span>${DOCKER_APT_REPO}</span>/gpg"</span> | sudo apt-key add -</span><br><span>OS=<span>"<span>$(lsb_release -cs)</span>"</span></span><br><span>sudo add-apt-repository <span>"deb [arch=amd64] <span>$DOCKER_APT_REPO</span> <span>$OS</span> stable"</span></span><br><span>sudo apt-get update</span><br><span>sudo apt-get -y -o Dpkg::Options::=<span>"--force-confnew"</span> install docker-ce</span><br></pre></td></tr></tbody></table>

#### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Docker-Experimental-Features "Docker Experimental Features")Docker Experimental Features

As of this writing (early 2020), buildx is an experimental feature. If you try to use it without turning on experimental features it’ll fail:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br></pre></td><td><pre><span><span>$</span><span> docker buildx</span></span><br><span>docker: 'buildx' is not a docker command.</span><br><span>See 'docker --help'</span><br></pre></td></tr></tbody></table>

You can turn on experimental Docker CLI features in one of two ways. Either by setting an environment variable

<table><tbody><tr><td><pre><span>1</span><br></pre></td><td><pre><span><span>$</span><span> <span>export</span> DOCKER_CLI_EXPERIMENTAL=enabled</span></span><br></pre></td></tr></tbody></table>

or by turning the feature on in the config file:

$HOME/.docker/config.json

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></pre></td><td><pre><span>{</span><br><span>  ...</span><br><span>  <span>"experimental"</span> : <span>"enabled"</span></span><br><span>}</span><br></pre></td></tr></tbody></table>

If you choose the environment variable, put the setting into you shell startup script, e.g. $HOME/.bashrc for bash, otherwise the setting only sticks around in your current shell until you log out. Once you have turned on experimental features either way, you can check that it has taken effect with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></pre></td><td><pre><span><span>$</span><span> docker version</span></span><br><span>Client: Docker Engine - Community</span><br><span> ...</span><br><span> Experimental:      true</span><br><span> ...</span><br></pre></td></tr></tbody></table>

Note that this output also shows you the status of the _Experimental_ flag of _Server: Docker Engine_. But this doesn’t concern us for now. With experimental mode now turned on, you should have access to the docker buildx command:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></pre></td><td><pre><span><span>$</span><span> docker buildx</span></span><br><span></span><br><span>Usage:  docker buildx COMMAND</span><br><span></span><br><span>Build with BuildKit</span><br><span></span><br><span>Management Commands:</span><br><span>  imagetools  Commands to work on images in registry</span><br><span></span><br><span>Commands:</span><br><span>  bake        Build from a file</span><br><span>  build       Start a build</span><br><span>  create      Create a new builder instance</span><br><span>  inspect     Inspect current builder instance</span><br><span>  ls          List builder instances</span><br><span>  rm          Remove a builder instance</span><br><span>  stop        Stop builder instance</span><br><span>  use         Set the current builder instance</span><br><span>  version     Show buildx version information</span><br><span></span><br><span>Run 'docker buildx COMMAND --help' for more information on a command.</span><br></pre></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Linux-Kernel "Linux Kernel")Linux Kernel

You need a kernel that supports the binfmt\_misc feature and has it enabled. In particular, the [binfmt\_misc support needed to use QEMU transparently inside containers](https://lwn.net/Articles/679308/) is the fix-binary (F) flag which requires a Linux kernel version >= 4.8 ([commit](https://git.kernel.org/torvalds/c/948b701a607f123df92ed29084413e5dd8cda2ed), [commit](https://git.kernel.org/torvalds/c/4af75df6a410ce76d9f60f27b07e5645ecc2c5ed)). You can check your kernel version with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>$</span><span> uname -r</span></span><br><span>4.15.0</span><br></pre></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Binfmt-misc-File-System "Binfmt_misc File System")Binfmt\_misc File System

The binfmt\_misc kernel features are controlled via files in `/proc/sys/fs/binfmt_misc/`. This file system must be mounted. E.g. on a Ubuntu 18.04 (bionic) system the script responsible for mounting that file system is `/lib/systemd/system/proc-sys-fs-binfmt_misc.automount` which is part of the `systemd` package and runs automatically at boot time (and also during package installation). You can check if the file system is mounted with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>$</span><span> ls /proc/sys/fs/binfmt_misc/</span></span><br><span>register  status</span><br></pre></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Host-Installation-QEMU "Host Installation: QEMU")Host Installation: QEMU

An easy way to install statically linked QEMU binaries is to use a pre-built package for your host Linux distribution. E.g. for Debian or Ubuntu you can install it with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br></pre></td><td><pre><span><span>$</span><span> sudo apt-get install -y qemu-user-static</span></span><br><span>Reading package lists... Done</span><br><span>Building dependency tree</span><br><span>Reading state information... Done</span><br><span>The following additional packages will be installed:</span><br><span>  binfmt-support</span><br><span>The following NEW packages will be installed:</span><br><span>  binfmt-support qemu-user-static</span><br><span>0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.</span><br><span>Need to get 10.1 MB of archives.</span><br><span>After this operation, 101 MB of additional disk space will be used.</span><br><span>Get:1 <a href="http://us-east-2.ec2.archive.ubuntu.com/ubuntu" rel="nofollow"><span>http</span><span>://</span><span>us</span><span>-</span><span>east</span><span>-</span><span>2</span><span>.</span><span>ec2</span><span>.</span><span>archive</span><span>.</span><span>ubuntu</span><span>.</span><span>com</span><span>/</span><span>ubuntu</span></a> bionic/main amd64 binfmt-support amd64 2.1.8-2 [51.6 kB]</span><br><span>Get:2 <a href="http://us-east-2.ec2.archive.ubuntu.com/ubuntu" rel="nofollow"><span>http</span><span>://</span><span>us</span><span>-</span><span>east</span><span>-</span><span>2</span><span>.</span><span>ec2</span><span>.</span><span>archive</span><span>.</span><span>ubuntu</span><span>.</span><span>com</span><span>/</span><span>ubuntu</span></a> bionic-updates/universe amd64 qemu-user-static amd64 1:2.11+dfsg-1ubuntu7.21 [10.0 MB]</span><br><span>Fetched 10.1 MB in 0s (22.0 MB/s)</span><br><span>Selecting previously unselected package binfmt-support.</span><br><span>(Reading database ... 120409 files and directories currently installed.)</span><br><span>Preparing to unpack .../binfmt-support_2.1.8-2_amd64.deb ...</span><br><span>Unpacking binfmt-support (2.1.8-2) ...</span><br><span>Selecting previously unselected package qemu-user-static.</span><br><span>Preparing to unpack .../qemu-user-static_1%3a2.11+dfsg-1ubuntu7.21_amd64.deb ...</span><br><span>Unpacking qemu-user-static (1:2.11+dfsg-1ubuntu7.21) ...</span><br><span>Setting up binfmt-support (2.1.8-2) ...</span><br><span>Setting up qemu-user-static (1:2.11+dfsg-1ubuntu7.21) ...</span><br><span>Processing triggers for ureadahead (0.100.0-21) ...</span><br><span>Processing triggers for systemd (237-3ubuntu10.33) ...</span><br><span>Processing triggers for man-db (2.8.3-2ubuntu0.1) ...</span><br></pre></td></tr></tbody></table>

That has installed QEMU for a number of foreign architectures, e.g. 64-bit ARM (aarch64), as you can see by checking:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></pre></td><td><pre><span><span>$</span><span> ls -l /usr/bin/qemu-aarch64-static</span></span><br><span>-rwxr-xr-x 1 root root 3621200 Oct 15 09:23 /usr/bin/qemu-aarch64-static</span><br><span><span></span></span><br><span><span>$</span><span> qemu-aarch64-static --version</span></span><br><span>qemu-aarch64 version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.21)</span><br><span>Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers</span><br></pre></td></tr></tbody></table>

Other Linux distributions might use different package managers or package names for the QEMU package. Alternatively you can install [QEMU from source](https://www.qemu.org/download/#source) and follow the build instructions.

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Host-Installation-update-binfmts-Tool "Host Installation: update-binfmts Tool")Host Installation: update-binfmts Tool

The update-binfmts tool is typically part of the binfmt-support package. If you look back at the installation of qemu-user-static above you’ll see that it has automatically pulled in the recommended binfmt-support package, so in our case it’s already installed. But if you’ve specified the `--no-install-recommends` flag (or that is set by default on your system), binfmt-support might not yet be installed. If it’s missing on your system you can also install it manually with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></pre></td><td><pre><span><span>$</span><span> sudo apt-get install -y binfmt-support</span></span><br><span>Reading package lists... Done</span><br><span>Building dependency tree</span><br><span>Reading state information... Done</span><br><span>binfmt-support is already the newest version (2.1.8-2).</span><br><span>binfmt-support set to manually installed.</span><br><span>0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</span><br></pre></td></tr></tbody></table>

Here again, we need support for the fix-binary (F) flag, which was [added to update-binfmts](https://git.savannah.gnu.org/cgit/binfmt-support.git/commit/?id=0e8b960d47109c002f1ccfc98849df588e8a1e92) with version 2.1.7. You can check the version with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>$</span><span> update-binfmts --version</span></span><br><span>binfmt-support 2.1.8</span><br></pre></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Checking-Your-Host-System "Checking Your Host System")Checking Your Host System

Putting everything together, you can check if the aforementioned environment is in place for using QEMU with docker buildx with the following check-qemu-binfmt.sh script:

<table data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="Shell" data-tagsearch-path="check-qemu-binfmt.sh"><tbody><tr><td id="file-check-qemu-binfmt-sh-L1" data-line-number="1"></td><td id="file-check-qemu-binfmt-sh-LC1"><span><span>#!</span>/bin/bash</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L2" data-line-number="2"></td><td id="file-check-qemu-binfmt-sh-LC2"><span><span>#</span> (c) 2020 Artur.Klauser@computer.org</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L3" data-line-number="3"></td><td id="file-check-qemu-binfmt-sh-LC3"><span><span>#</span> SPDX-License-Identifier: Apache-2.0 OR MIT</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L4" data-line-number="4"></td><td id="file-check-qemu-binfmt-sh-LC4"><span><span>#</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L5" data-line-number="5"></td><td id="file-check-qemu-binfmt-sh-LC5"><span><span>#</span> This script checks if all software requirements are met in a Linux environment</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L6" data-line-number="6"></td><td id="file-check-qemu-binfmt-sh-LC6"><span><span>#</span> in order to use 'docker buildx' to build multi-architecture images.</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L7" data-line-number="7"></td><td id="file-check-qemu-binfmt-sh-LC7"><span><span>#</span> For more information see:</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L8" data-line-number="8"></td><td id="file-check-qemu-binfmt-sh-LC8"><span><span>#</span> <a href="https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/" rel="nofollow"><span>https</span><span>://</span><span>nexus</span><span>.</span><span>eddiesinentropy</span><span>.</span><span>net</span><span>/</span><span>2020</span><span>/</span><span>01</span><span>/</span><span>12</span><span>/</span><span>Building</span><span>-</span><span>Multi</span><span>-</span><span>architecture</span><span>-</span><span>Docker</span><span>-</span><span>Images</span><span>-</span><span>With</span><span>-</span><span>Buildx</span><span>/</span></a></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L9" data-line-number="9"></td><td id="file-check-qemu-binfmt-sh-LC9"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L10" data-line-number="10"></td><td id="file-check-qemu-binfmt-sh-LC10"><span>function</span> <span>error()</span> {</td></tr><tr><td id="file-check-qemu-binfmt-sh-L11" data-line-number="11"></td><td id="file-check-qemu-binfmt-sh-LC11"><span>echo</span> <span><span>"</span>ERROR: <span>$*</span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L12" data-line-number="12"></td><td id="file-check-qemu-binfmt-sh-LC12"><span>exit</span> 1</td></tr><tr><td id="file-check-qemu-binfmt-sh-L13" data-line-number="13"></td><td id="file-check-qemu-binfmt-sh-LC13">}</td></tr><tr><td id="file-check-qemu-binfmt-sh-L14" data-line-number="14"></td><td id="file-check-qemu-binfmt-sh-LC14"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L15" data-line-number="15"></td><td id="file-check-qemu-binfmt-sh-LC15"><span>function</span> <span>ok()</span> {</td></tr><tr><td id="file-check-qemu-binfmt-sh-L16" data-line-number="16"></td><td id="file-check-qemu-binfmt-sh-LC16"><span>echo</span> <span><span>"</span>OK: <span>$*</span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L17" data-line-number="17"></td><td id="file-check-qemu-binfmt-sh-LC17">}</td></tr><tr><td id="file-check-qemu-binfmt-sh-L18" data-line-number="18"></td><td id="file-check-qemu-binfmt-sh-LC18"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L19" data-line-number="19"></td><td id="file-check-qemu-binfmt-sh-LC19"><span>function</span> <span>version()</span> {</td></tr><tr><td id="file-check-qemu-binfmt-sh-L20" data-line-number="20"></td><td id="file-check-qemu-binfmt-sh-LC20"><span>printf</span> <span><span>'</span>%02d<span>'</span></span> <span><span>$(</span>echo <span><span>"</span><span>$1</span><span>"</span></span> <span>|</span> tr <span>.</span> <span><span>'</span> <span>'</span></span> <span>|</span> sed -e <span><span>'</span>s/ 0*/ /g<span>'</span></span><span>)</span></span> <span>2&gt;</span>/dev/null</td></tr><tr><td id="file-check-qemu-binfmt-sh-L21" data-line-number="21"></td><td id="file-check-qemu-binfmt-sh-LC21">}</td></tr><tr><td id="file-check-qemu-binfmt-sh-L22" data-line-number="22"></td><td id="file-check-qemu-binfmt-sh-LC22"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L23" data-line-number="23"></td><td id="file-check-qemu-binfmt-sh-LC23"><span>function</span> <span>check_qemu_binfmt()</span> {</td></tr><tr><td id="file-check-qemu-binfmt-sh-L24" data-line-number="24"></td><td id="file-check-qemu-binfmt-sh-LC24"><span><span>#</span> Docker</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L25" data-line-number="25"></td><td id="file-check-qemu-binfmt-sh-LC25"><span>if</span> <span>!</span> <span>command</span> -v docker <span>&gt;</span>/dev/null <span>2&gt;&amp;1</span><span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L26" data-line-number="26"></td><td id="file-check-qemu-binfmt-sh-LC26">error <span><span>"</span>Can't find docker.<span>"</span></span> \</td></tr><tr><td id="file-check-qemu-binfmt-sh-L27" data-line-number="27"></td><td id="file-check-qemu-binfmt-sh-LC27"><span><span>"</span>Install with 'sudo apt-get install docker-ce' or docker.io.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L28" data-line-number="28"></td><td id="file-check-qemu-binfmt-sh-LC28"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L29" data-line-number="29"></td><td id="file-check-qemu-binfmt-sh-LC29">docker_version=<span><span>"</span><span><span>$(</span>docker --version <span>|</span> cut -d<span><span>'</span> <span>'</span></span> -f3 <span>|</span> tr -cd <span><span>'</span>0-9.<span>'</span></span><span>)</span></span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L30" data-line-number="30"></td><td id="file-check-qemu-binfmt-sh-LC30"><span>if</span> [[ <span><span>"</span><span><span>$(</span>version <span><span>"</span><span>$docker_version</span><span>"</span></span><span>)</span></span><span>"</span></span> <span>&lt;</span> <span><span>"</span><span><span>$(</span>version <span><span>'</span>19.03<span>'</span></span><span>)</span></span><span>"</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L31" data-line-number="31"></td><td id="file-check-qemu-binfmt-sh-LC31">error <span><span>"</span>docker <span>$docker_version</span> too old. Need &gt;= 19.03<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L32" data-line-number="32"></td><td id="file-check-qemu-binfmt-sh-LC32"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L33" data-line-number="33"></td><td id="file-check-qemu-binfmt-sh-LC33">docker_experimental=<span><span>"</span><span><span>$(</span>docker version <span>|</span> \</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L34" data-line-number="34"></td><td id="file-check-qemu-binfmt-sh-LC34"><span><span>awk <span><span>'</span>/^ *Experimental:/ {print $2 ; exit}<span>'</span></span><span>)</span></span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L35" data-line-number="35"></td><td id="file-check-qemu-binfmt-sh-LC35"><span>if</span> [[ <span><span>"</span><span>$docker_experimental</span><span>"</span></span> <span>!=</span> <span><span>'</span>true<span>'</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L36" data-line-number="36"></td><td id="file-check-qemu-binfmt-sh-LC36">error <span><span>"</span>docker experimental flag not enabled:<span>"</span></span>\</td></tr><tr><td id="file-check-qemu-binfmt-sh-L37" data-line-number="37"></td><td id="file-check-qemu-binfmt-sh-LC37"><span><span>"</span>Set with 'export DOCKER_CLI_EXPERIMENTAL=enabled'<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L38" data-line-number="38"></td><td id="file-check-qemu-binfmt-sh-LC38"><span>else</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L39" data-line-number="39"></td><td id="file-check-qemu-binfmt-sh-LC39">ok <span><span>"</span>docker <span>$docker_version</span> supports buildx experimental feature.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L40" data-line-number="40"></td><td id="file-check-qemu-binfmt-sh-LC40"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L41" data-line-number="41"></td><td id="file-check-qemu-binfmt-sh-LC41"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L42" data-line-number="42"></td><td id="file-check-qemu-binfmt-sh-LC42"><span><span>#</span> Kernel</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L43" data-line-number="43"></td><td id="file-check-qemu-binfmt-sh-LC43">kernel_version=<span><span>"</span><span><span>$(</span>uname -r<span>)</span></span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L44" data-line-number="44"></td><td id="file-check-qemu-binfmt-sh-LC44"><span>if</span> [[ <span><span>"</span><span><span>$(</span>version <span><span>"</span><span>$kernel_version</span><span>"</span></span><span>)</span></span><span>"</span></span> <span>&lt;</span> <span><span>"</span><span><span>$(</span>version <span><span>'</span>4.8<span>'</span></span><span>)</span></span><span>"</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L45" data-line-number="45"></td><td id="file-check-qemu-binfmt-sh-LC45">error <span><span>"</span>Kernel <span>$kernel_version</span> too old - need &gt;= 4.8.<span>"</span></span> \</td></tr><tr><td id="file-check-qemu-binfmt-sh-L46" data-line-number="46"></td><td id="file-check-qemu-binfmt-sh-LC46"><span><span>"</span> Install a newer kernel.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L47" data-line-number="47"></td><td id="file-check-qemu-binfmt-sh-LC47"><span>else</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L48" data-line-number="48"></td><td id="file-check-qemu-binfmt-sh-LC48">ok <span><span>"</span>kernel <span>$kernel_version</span> has binfmt_misc fix-binary (F) support.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L49" data-line-number="49"></td><td id="file-check-qemu-binfmt-sh-LC49"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L50" data-line-number="50"></td><td id="file-check-qemu-binfmt-sh-LC50"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L51" data-line-number="51"></td><td id="file-check-qemu-binfmt-sh-LC51"><span><span>#</span> binfmt_misc file system</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L52" data-line-number="52"></td><td id="file-check-qemu-binfmt-sh-LC52"><span>if</span> [[ <span><span>"</span><span><span>$(</span>mount <span>|</span> grep -c <span><span>'</span>/proc/sys/fs/binfmt_misc<span>'</span></span><span>)</span></span><span>"</span></span> <span>==</span> <span><span>'</span>0<span>'</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L53" data-line-number="53"></td><td id="file-check-qemu-binfmt-sh-LC53">error <span><span>'</span>/proc/sys/fs/binfmt_misc not mounted. Mount with<span>'</span></span> \</td></tr><tr><td id="file-check-qemu-binfmt-sh-L54" data-line-number="54"></td><td id="file-check-qemu-binfmt-sh-LC54"><span><span>"</span>'sudo mount -t binfmt_misc binfmt_misc /proc/sys/fs/binfmt_misc'<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L55" data-line-number="55"></td><td id="file-check-qemu-binfmt-sh-LC55"><span>else</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L56" data-line-number="56"></td><td id="file-check-qemu-binfmt-sh-LC56">ok <span><span>"</span>/proc/sys/fs/binfmt_misc is mounted<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L57" data-line-number="57"></td><td id="file-check-qemu-binfmt-sh-LC57"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L58" data-line-number="58"></td><td id="file-check-qemu-binfmt-sh-LC58"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L59" data-line-number="59"></td><td id="file-check-qemu-binfmt-sh-LC59"><span><span>#</span> binfmt-support</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L60" data-line-number="60"></td><td id="file-check-qemu-binfmt-sh-LC60"><span>if</span> <span>!</span> <span>command</span> -v update-binfmts <span>&gt;</span>/dev/null <span>2&gt;&amp;1</span><span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L61" data-line-number="61"></td><td id="file-check-qemu-binfmt-sh-LC61">error <span><span>"</span>Can't find update-binfmts.<span>"</span></span> \</td></tr><tr><td id="file-check-qemu-binfmt-sh-L62" data-line-number="62"></td><td id="file-check-qemu-binfmt-sh-LC62"><span><span>"</span>Install with 'sudo apt-get install binfmt-support'.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L63" data-line-number="63"></td><td id="file-check-qemu-binfmt-sh-LC63"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L64" data-line-number="64"></td><td id="file-check-qemu-binfmt-sh-LC64">binfmt_version=<span><span>"</span><span><span>$(</span>update-binfmts --version <span>|</span> awk <span><span>'</span>{print $NF}<span>'</span></span><span>)</span></span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L65" data-line-number="65"></td><td id="file-check-qemu-binfmt-sh-LC65"><span>if</span> [[ <span><span>"</span><span><span>$(</span>version <span><span>"</span><span>$binfmt_version</span><span>"</span></span><span>)</span></span><span>"</span></span> <span>&lt;</span> <span><span>"</span><span><span>$(</span>version <span><span>'</span>2.1.7<span>'</span></span><span>)</span></span><span>"</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L66" data-line-number="66"></td><td id="file-check-qemu-binfmt-sh-LC66">error <span><span>"</span>update-binfmts <span>$binfmt_version</span> too old. Need &gt;= 2.1.7<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L67" data-line-number="67"></td><td id="file-check-qemu-binfmt-sh-LC67"><span>else</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L68" data-line-number="68"></td><td id="file-check-qemu-binfmt-sh-LC68">ok <span><span>"</span>update-binfmts <span>$binfmt_version</span> has fix-binary (F) support.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L69" data-line-number="69"></td><td id="file-check-qemu-binfmt-sh-LC69"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L70" data-line-number="70"></td><td id="file-check-qemu-binfmt-sh-LC70"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L71" data-line-number="71"></td><td id="file-check-qemu-binfmt-sh-LC71"><span><span>#</span> QEMU</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L72" data-line-number="72"></td><td id="file-check-qemu-binfmt-sh-LC72"><span>if</span> [[ <span>!</span> <span>-e</span> <span><span>'</span>/proc/sys/fs/binfmt_misc/qemu-aarch64<span>'</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L73" data-line-number="73"></td><td id="file-check-qemu-binfmt-sh-LC73"><span><span>#</span> Skip this test if QEMU isn't registered with binfmt_misc. It might</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L74" data-line-number="74"></td><td id="file-check-qemu-binfmt-sh-LC74"><span><span>#</span> come from a docker image rather than the host file system.</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L75" data-line-number="75"></td><td id="file-check-qemu-binfmt-sh-LC75"><span>if</span> [[ <span>!</span> <span>-e</span> <span><span>'</span>/usr/bin/qemu-aarch64-static<span>'</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L76" data-line-number="76"></td><td id="file-check-qemu-binfmt-sh-LC76">error <span><span>"</span>Missing QEMU.<span>"</span></span> \</td></tr><tr><td id="file-check-qemu-binfmt-sh-L77" data-line-number="77"></td><td id="file-check-qemu-binfmt-sh-LC77"><span><span>"</span> Install with 'sudo apt-get install qemu-user-static'.<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L78" data-line-number="78"></td><td id="file-check-qemu-binfmt-sh-LC78"><span>else</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L79" data-line-number="79"></td><td id="file-check-qemu-binfmt-sh-LC79">ok <span><span>"</span>QEMU installed<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L80" data-line-number="80"></td><td id="file-check-qemu-binfmt-sh-LC80"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L81" data-line-number="81"></td><td id="file-check-qemu-binfmt-sh-LC81"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L82" data-line-number="82"></td><td id="file-check-qemu-binfmt-sh-LC82"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L83" data-line-number="83"></td><td id="file-check-qemu-binfmt-sh-LC83"><span>if</span> [[ <span>!</span> <span>-e</span> <span><span>'</span>/proc/sys/fs/binfmt_misc/qemu-aarch64<span>'</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L84" data-line-number="84"></td><td id="file-check-qemu-binfmt-sh-LC84">error <span><span>'</span>QEMU not registered in binfmt_misc.<span>'</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L85" data-line-number="85"></td><td id="file-check-qemu-binfmt-sh-LC85"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L86" data-line-number="86"></td><td id="file-check-qemu-binfmt-sh-LC86">flags=<span><span>"</span><span><span>$(</span>grep <span><span>'</span>flags:<span>'</span></span> /proc/sys/fs/binfmt_misc/qemu-aarch64 <span>|</span> \</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L87" data-line-number="87"></td><td id="file-check-qemu-binfmt-sh-LC87"><span><span>cut -d<span><span>'</span> <span>'</span></span> -f2<span>)</span></span><span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L88" data-line-number="88"></td><td id="file-check-qemu-binfmt-sh-LC88"><span>if</span> [[ <span><span>"</span><span><span>$(</span>echo <span><span>"</span><span>$flags</span><span>"</span></span> <span>|</span> grep -c F<span>)</span></span><span>"</span></span> <span>==</span> <span><span>'</span>0<span>'</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L89" data-line-number="89"></td><td id="file-check-qemu-binfmt-sh-LC89">error <span><span>'</span>QEMU not registered in binfmt_misc with fix-binary (F) flag.<span>'</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L90" data-line-number="90"></td><td id="file-check-qemu-binfmt-sh-LC90"><span>else</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L91" data-line-number="91"></td><td id="file-check-qemu-binfmt-sh-LC91">ok <span><span>"</span>QEMU registered in binfmt_misc with flags <span>$flags</span> (F is required).<span>"</span></span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L92" data-line-number="92"></td><td id="file-check-qemu-binfmt-sh-LC92"><span>fi</span></td></tr><tr><td id="file-check-qemu-binfmt-sh-L93" data-line-number="93"></td><td id="file-check-qemu-binfmt-sh-LC93"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L94" data-line-number="94"></td><td id="file-check-qemu-binfmt-sh-LC94"><span>echo</span> <span><span>"</span>Host looks good for docker buildx multi-architecture support<span>"</span></span>.</td></tr><tr><td id="file-check-qemu-binfmt-sh-L95" data-line-number="95"></td><td id="file-check-qemu-binfmt-sh-LC95">}</td></tr><tr><td id="file-check-qemu-binfmt-sh-L96" data-line-number="96"></td><td id="file-check-qemu-binfmt-sh-LC96"></td></tr><tr><td id="file-check-qemu-binfmt-sh-L97" data-line-number="97"></td><td id="file-check-qemu-binfmt-sh-LC97"><span>set</span> -e</td></tr><tr><td id="file-check-qemu-binfmt-sh-L98" data-line-number="98"></td><td id="file-check-qemu-binfmt-sh-LC98">check_qemu_binfmt <span><span>"</span><span>$@</span><span>"</span></span></td></tr></tbody></table>

#### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Problem-QEMU-Not-Registered-With-F-Flag "Problem: QEMU Not Registered With (F) Flag")Problem: QEMU Not Registered With (F) Flag

In some environments you can run into the situation that the appropriate kernel and update-binfmts support is present, but the qemu-user-static post-install script does not register QEMU with the fix-binary (F) flag. The checker script above will point that out. One such environment is e.g. AWS EC2 instances running Ubuntu 18.04 (bionic). In such a case you can _fix up_ the installation by re-registering QEMU with the fix-binary (F) flag with the following reregister-qemu-binfmt.sh script:

<table data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="Shell" data-tagsearch-path="reregister-qemu-binfmt.sh"><tbody><tr><td id="file-reregister-qemu-binfmt-sh-L1" data-line-number="1"></td><td id="file-reregister-qemu-binfmt-sh-LC1"><span><span>#!</span>/bin/bash</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L2" data-line-number="2"></td><td id="file-reregister-qemu-binfmt-sh-LC2"><span><span>#</span> (c) 2020 Artur.Klauser@computer.org</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L3" data-line-number="3"></td><td id="file-reregister-qemu-binfmt-sh-LC3"><span><span>#</span> SPDX-License-Identifier: Apache-2.0 OR MIT</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L4" data-line-number="4"></td><td id="file-reregister-qemu-binfmt-sh-LC4"><span><span>#</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L5" data-line-number="5"></td><td id="file-reregister-qemu-binfmt-sh-LC5"><span><span>#</span> This script tries to reregister QEMU's binfmt_misc handlers with the</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L6" data-line-number="6"></td><td id="file-reregister-qemu-binfmt-sh-LC6"><span><span>#</span> fix-binary (F) flag in order to be usable with 'docker buildx' to build</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L7" data-line-number="7"></td><td id="file-reregister-qemu-binfmt-sh-LC7"><span><span>#</span> multi-architecture images.</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L8" data-line-number="8"></td><td id="file-reregister-qemu-binfmt-sh-LC8"><span><span>#</span> For more information see:</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L9" data-line-number="9"></td><td id="file-reregister-qemu-binfmt-sh-LC9"><span><span>#</span> <a href="https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/" rel="nofollow"><span>https</span><span>://</span><span>nexus</span><span>.</span><span>eddiesinentropy</span><span>.</span><span>net</span><span>/</span><span>2020</span><span>/</span><span>01</span><span>/</span><span>12</span><span>/</span><span>Building</span><span>-</span><span>Multi</span><span>-</span><span>architecture</span><span>-</span><span>Docker</span><span>-</span><span>Images</span><span>-</span><span>With</span><span>-</span><span>Buildx</span><span>/</span></a></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L10" data-line-number="10"></td><td id="file-reregister-qemu-binfmt-sh-LC10"></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L11" data-line-number="11"></td><td id="file-reregister-qemu-binfmt-sh-LC11"><span>function</span> <span>remove_binfmt()</span> {</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L12" data-line-number="12"></td><td id="file-reregister-qemu-binfmt-sh-LC12"><span>local</span> arch=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L13" data-line-number="13"></td><td id="file-reregister-qemu-binfmt-sh-LC13"><span>local</span> package=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L14" data-line-number="14"></td><td id="file-reregister-qemu-binfmt-sh-LC14">update-binfmts \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L15" data-line-number="15"></td><td id="file-reregister-qemu-binfmt-sh-LC15">--package <span><span>"</span><span>${package}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L16" data-line-number="16"></td><td id="file-reregister-qemu-binfmt-sh-LC16">--remove <span><span>"</span>qemu-<span>${arch}</span><span>"</span></span> <span><span>"</span>/usr/bin/qemu-<span>${arch}</span>-static<span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L17" data-line-number="17"></td><td id="file-reregister-qemu-binfmt-sh-LC17">}</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L18" data-line-number="18"></td><td id="file-reregister-qemu-binfmt-sh-LC18"></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L19" data-line-number="19"></td><td id="file-reregister-qemu-binfmt-sh-LC19"><span>function</span> <span>install_binfmt()</span> {</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L20" data-line-number="20"></td><td id="file-reregister-qemu-binfmt-sh-LC20"><span>local</span> arch=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L21" data-line-number="21"></td><td id="file-reregister-qemu-binfmt-sh-LC21"><span>local</span> package=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L22" data-line-number="22"></td><td id="file-reregister-qemu-binfmt-sh-LC22"><span>local</span> interpreter=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L23" data-line-number="23"></td><td id="file-reregister-qemu-binfmt-sh-LC23"><span>local</span> offset=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L24" data-line-number="24"></td><td id="file-reregister-qemu-binfmt-sh-LC24"><span>local</span> magic=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L25" data-line-number="25"></td><td id="file-reregister-qemu-binfmt-sh-LC25"><span>local</span> mask=<span><span>"</span><span>$1</span><span>"</span></span><span>;</span> <span>shift</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L26" data-line-number="26"></td><td id="file-reregister-qemu-binfmt-sh-LC26">update-binfmts \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L27" data-line-number="27"></td><td id="file-reregister-qemu-binfmt-sh-LC27">--package <span><span>"</span><span>${package}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L28" data-line-number="28"></td><td id="file-reregister-qemu-binfmt-sh-LC28">--install <span><span>"</span>qemu-<span>${arch}</span><span>"</span></span> <span><span>"</span><span>${interpreter}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L29" data-line-number="29"></td><td id="file-reregister-qemu-binfmt-sh-LC29">--offset <span><span>"</span><span>${offset}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L30" data-line-number="30"></td><td id="file-reregister-qemu-binfmt-sh-LC30">--magic <span><span>"</span><span>${magic}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L31" data-line-number="31"></td><td id="file-reregister-qemu-binfmt-sh-LC31">--mask <span><span>"</span><span>${mask}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L32" data-line-number="32"></td><td id="file-reregister-qemu-binfmt-sh-LC32">--credentials yes \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L33" data-line-number="33"></td><td id="file-reregister-qemu-binfmt-sh-LC33">--fix-binary yes</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L34" data-line-number="34"></td><td id="file-reregister-qemu-binfmt-sh-LC34">}</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L35" data-line-number="35"></td><td id="file-reregister-qemu-binfmt-sh-LC35"></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L36" data-line-number="36"></td><td id="file-reregister-qemu-binfmt-sh-LC36"><span>function</span> <span>reregister_qemu_binfmt()</span> {</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L37" data-line-number="37"></td><td id="file-reregister-qemu-binfmt-sh-LC37"><span><span>#</span> Reregister all qemu interpreters with fix-binary flag which makes them</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L38" data-line-number="38"></td><td id="file-reregister-qemu-binfmt-sh-LC38"><span><span>#</span> available inside containers and chroots, e.g. docker buildx works for</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L39" data-line-number="39"></td><td id="file-reregister-qemu-binfmt-sh-LC39"><span><span>#</span> architectures supported by qemu interpreters.</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L40" data-line-number="40"></td><td id="file-reregister-qemu-binfmt-sh-LC40"><span>for</span> <span>file</span> <span>in</span> /proc/sys/fs/binfmt_misc/qemu-<span>*</span><span>;</span> <span>do</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L41" data-line-number="41"></td><td id="file-reregister-qemu-binfmt-sh-LC41">arch=<span><span>"</span><span>${file<span>/*</span>qemu-<span>/</span>}</span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L42" data-line-number="42"></td><td id="file-reregister-qemu-binfmt-sh-LC42">package=<span><span>"</span><span><span>$(</span>head -1 <span><span>"</span>/var/lib/binfmts/qemu-<span>${arch}</span><span>"</span></span><span>)</span></span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L43" data-line-number="43"></td><td id="file-reregister-qemu-binfmt-sh-LC43"><span><span>#</span> Pull arguments from current registration.</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L44" data-line-number="44"></td><td id="file-reregister-qemu-binfmt-sh-LC44"><span>eval</span> <span><span>$(</span>awk <span><span>'</span> \</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L45" data-line-number="45"></td><td id="file-reregister-qemu-binfmt-sh-LC45"><span><span>/^(interpreter|offset|magic|mask)/ {printf "%s=\"%s\"\n",$1,$2}<span>'</span></span> \</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L46" data-line-number="46"></td><td id="file-reregister-qemu-binfmt-sh-LC46"><span><span><span>"</span><span>${file}</span><span>"</span></span><span>)</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L47" data-line-number="47"></td><td id="file-reregister-qemu-binfmt-sh-LC47"><span><span>#</span> Convert to binary strings.</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L48" data-line-number="48"></td><td id="file-reregister-qemu-binfmt-sh-LC48">magic=<span><span>"</span><span><span>$(</span>echo <span>$magic</span> <span>|</span> sed <span><span>'</span>s/\(..\)/\\x\1/g<span>'</span></span><span>)</span></span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L49" data-line-number="49"></td><td id="file-reregister-qemu-binfmt-sh-LC49">mask=<span><span>"</span><span><span>$(</span>echo <span>$mask</span> <span>|</span> sed <span><span>'</span>s/\(..\)/\\x\1/g<span>'</span></span><span>)</span></span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L50" data-line-number="50"></td><td id="file-reregister-qemu-binfmt-sh-LC50"><span>echo</span> <span><span>"</span>Reregistering arch <span>$arch</span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L51" data-line-number="51"></td><td id="file-reregister-qemu-binfmt-sh-LC51">remove_binfmt <span><span>"</span><span>${arch}</span><span>"</span></span> <span><span>"</span><span>${package}</span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L52" data-line-number="52"></td><td id="file-reregister-qemu-binfmt-sh-LC52">install_binfmt <span><span>"</span><span>${arch}</span><span>"</span></span> <span><span>"</span><span>${package}</span><span>"</span></span> <span><span>"</span><span>${interpreter}</span><span>"</span></span> \</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L53" data-line-number="53"></td><td id="file-reregister-qemu-binfmt-sh-LC53"><span><span>"</span><span>${offset}</span><span>"</span></span> <span><span>"</span><span>${magic}</span><span>"</span></span> <span><span>"</span><span>${mask}</span><span>"</span></span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L54" data-line-number="54"></td><td id="file-reregister-qemu-binfmt-sh-LC54"><span>done</span></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L55" data-line-number="55"></td><td id="file-reregister-qemu-binfmt-sh-LC55">}</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L56" data-line-number="56"></td><td id="file-reregister-qemu-binfmt-sh-LC56"></td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L57" data-line-number="57"></td><td id="file-reregister-qemu-binfmt-sh-LC57"><span>set</span> -e</td></tr><tr><td id="file-reregister-qemu-binfmt-sh-L58" data-line-number="58"></td><td id="file-reregister-qemu-binfmt-sh-LC58">reregister_qemu_binfmt <span><span>"</span><span>$@</span><span>"</span></span></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Docker-Image-Based-Installation "Docker Image Based Installation")Docker Image Based Installation

As an alternative to installing the QEMU and binfmt-support packages on your host system you can use a docker image to satisfy the corresponding requirements. There are several docker images that do the job, among them [multiarch/qemu-user-static](https://github.com/multiarch/qemu-user-static) and [docker/binfmt](https://github.com/docker/binfmt). They come loaded with QEMU simulators for several architectures and their own setup script for installing those QEMU simulators in the host kernel’s binfmt\_misc with the fix-binary (F) flag. The QEMU simulators stay registered and usable by the host kernel after running that docker image as long as the host system remains up (or you explicitly unregister them from binfmt\_misc). That is what also makes them usable by later runs of docker buildx. Unlike the host installation of packages though, you’ll need to **re-run that docker image after every system reboot**.

Using those images doesn’t release you from having the right docker and kernel version on the host system, but you do get around installing QEMU and binfmt-support packages on the host. I like to use `multiarch/qemu-user-static`:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></pre></td><td><pre><span><span>$</span><span> docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</span></span><br><span>Unable to find image 'multiarch/qemu-user-static:latest' locally</span><br><span>latest: Pulling from multiarch/qemu-user-static</span><br><span>bdbbaa22dec6: Pull complete</span><br><span>42399a41a764: Pull complete</span><br><span>ed8a5179ae11: Pull complete</span><br><span>1ec39da9c97d: Pull complete</span><br><span>df7dd9470aac: Pull complete</span><br><span>Digest: sha256:25d6e8bb037094525cd70da43edc06a62122028cb9ad434605affbd4fffb3a4f</span><br><span>Status: Downloaded newer image for multiarch/qemu-user-static:latest</span><br><span>Setting /usr/bin/qemu-alpha-static as binfmt interpreter for alpha</span><br><span>Setting /usr/bin/qemu-arm-static as binfmt interpreter for arm</span><br><span>Setting /usr/bin/qemu-armeb-static as binfmt interpreter for armeb</span><br><span>...</span><br></pre></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Status-of-Popular-Linux-Environments "Status of Popular Linux Environments")Status of Popular Linux Environments

The following table shows the current status of docker buildx support on various popular Linux environments. Only Ubuntu >= 19.10 (eoan) and Debian 11 (bullseye/testing) come with sufficient support by default to be able to run docker buildx out of the box. All older versions of these Linux distributions need updates of various components in order to be compatible with docker buildx usage. For example Ubuntu 18.04 (bionic) requires [re-registration of QEMU with the fix-binary (F) flag](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Problem-QEMU-Not-Registered-With-F-Flag) or usage of the [docker image installation method for QEMU](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Docker-Image-Based-Installation) as described above as well as an [upgraded docker package](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Docker).

| Environment | Docker Package | Kernel | binfmt-support | (F) Flag |
| --- | --- | --- | --- | --- |
| **Requirements** | \>= 19.03 | \>= 4.8 | \>= 2.1.7 | yes |
| **Ubuntu:** |  |  |  |  |
| 18.04 (bionic) | 17.12.1 docker.io | 4.15.0 | 2.1.8 | no |
| 19.04 (disco) | 18.09.5 docker.io | 5.0 | 2.2.0 | yes |
| 19.10 (eoan) | 19.03.2 docker.io | 5.3 | 2.2.0 | yes |
| 20.04 (focal) | 19.03.2 docker.io | 5.5 | 2.2.0 | yes |
| **Debian:** |  |  |  |  |
| 9 (stretch) | \- | 4.9.0 | 2.1.6 | no |
| 10 (buster) | 18.09.1 docker.io | 4.19.0 | 2.2.0 | yes |
| 11 (bullseye/testing) | 19.03.4 docker.io | 5.4 | 2.2.0 | yes |
| **AWS EC2:** |  |  |  |  |
| Ubuntu 16.04 (xenial) | 18.09.7 docker.io | 4.4.0 | 2.1.6 | no |
| Ubuntu 18.04 (bionic) | 18.09.7 docker.io | 4.15.0 | 2.1.8 | no |
| **Travis (on GCP):** |  |  |  |  |
| Ubuntu 14.04 (trusty) | 17.09.0 docker-ce | 4.4.0 | 2.1.4 | no |
| Ubuntu 16.04 (xenial) | 18.06.0 docker-ce | 4.15.0 | 2.1.6 | no |
| Ubuntu 18.04 (bionic) | 18.06.0 docker-ce | 4.15.0 | 2.1.8 | no |
| **Github Actions (on Azure):** |  |  |  |  |
| Ubuntu 16.04 (xenial) | 3.0.8 moby-engine | 4.15.0 | 2.1.6 | no |
| Ubuntu 18.04 (bionic) | 3.0.8 moby-engine | 5.0.0 | 2.1.8 | no |

## [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Building-Multi-Architecture-Docker-Images-With-Buildx "Building Multi-Architecture Docker Images With Buildx")Building Multi-Architecture Docker Images With Buildx

With all the software requirements on the host met, it’s time to turn our attention to how buildx is used to create multi-architecture docker images. The first step is setting up a buildx builder.

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Creating-a-Buildx-Builder "Creating a Buildx Builder")Creating a Buildx Builder

The docker CLI now understands the buildx command, but you also need to create a new builder instance which buildx can use:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br></pre></td><td><pre><span><span>$</span><span> docker buildx create --name mybuilder</span></span><br><span>mybuilder</span><br><span><span>$</span><span> docker buildx use mybuilder</span></span><br></pre></td></tr></tbody></table>

You can check your newly created _mybuilder_ with:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></pre></td><td><pre><span><span>$</span><span> docker buildx inspect --bootstrap</span></span><br><span>[+] Building 3.5s (1/1) FINISHED</span><br><span> =&gt; [internal] booting buildkit                                         3.5s</span><br><span> =&gt; =&gt; pulling image moby/buildkit:buildx-stable-1                      2.9s</span><br><span> =&gt; =&gt; creating container buildx_buildkit_mybuilder0                    0.6s</span><br><span>Name:   mybuilder</span><br><span>Driver: docker-container</span><br><span></span><br><span>Nodes:</span><br><span>Name:      mybuilder0</span><br><span>Endpoint:  unix:///var/run/docker.sock</span><br><span>Status:    running</span><br><span>Platforms: linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le,</span><br><span>linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span><br></pre></td></tr></tbody></table>

Note how the _Platforms_ line reports support for various non-native architectures which you have installed via QEMU. If it only reports support for _linux/amd64_ and _linux/386_ you either still haven’t met all [software requirements](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Software-Requirements-for-Buildx-Non-Native-Architecture-Support), or you had created a builder before you have met the software requirements. In the latter case remove it with `docker buildx rm` and recreate it.

You can also see your just created _mybuilder_ with buildx’ _ls_ subcommand:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></pre></td><td><pre><span><span>$</span><span> docker buildx ls</span></span><br><span>NAME/NODE    DRIVER/ENDPOINT             STATUS  PLATFORMS</span><br><span>mybuilder *  docker-container</span><br><span>  mybuilder0 unix:///var/run/docker.sock running linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span><br><span>default      docker</span><br><span>  default    default                     running linux/amd64, linux/arm64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span><br></pre></td></tr></tbody></table>

### [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Using-Buildx-to-Build "Using Buildx to Build")Using Buildx to Build

Alright, now we’re ready to build multi-architecture docker images with buildx. To have something concrete to work with we’re going to use the following example:

Dockerfile

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>FROM</span> alpine:latest</span><br><span><span>CMD</span><span> <span>echo</span> <span>"Running on <span>$(uname -m)</span>"</span></span></span><br></pre></td></tr></tbody></table>

It’s a simple stand-in for whatever you’d like to build yourself in your own Dockerfile. It uses the latest _Alpine_ distribution - which itself is a multi-architecture docker image - and prints out the architecture on which it is executing. That will allow us to check which kind of image we’re running.

The `docker buildx build` subcommand has a number of flags which determine where the final image will be stored. By default, i.e. if none of the flags are specified, the resulting image will remain captive in docker’s internal build cache. This is unlike the regular `docker build` command which stores the resulting image in the local `docker images` list. The important flags are:

-   **`--load`**: This flag instructs docker to load the resulting image into the local `docker images` list. However, this currently only works for single-architecture images. If you try this with multi-architecture images you’ll get an export error:
    
    ```
    $ docker buildx build ... --load ...... => ERROR exporting to oci image format                                0.0s------ > exporting to oci image format:------failed to solve: rpc error: code = Unknown desc = docker  exporter does not currently support exporting manifest lists
    ```
    
-   **`--push`**: This flag tells docker to push the resulting image to a docker registry. Your image tag has to contain the proper reference to the registry and repository name. This currently is the best way to store multi-architecture images.

We’re going to use the default Docker Hub registry. First we have to log in:

Now we can build and use the `--push` flag to push the image to Docker Hub. In our example we’re going to build for three different architectures - x86, ARM, and PowerPC - which are specified with the `--platform` flag:

We can check the image with the `imagetools` subcommand which confirms that three architecture versions are included in the image:

Also, on the Docker Hub web site we see it reported as:

[![](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/docker-hub-info.png "Docker Hub Info")](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/docker-hub-info.png)

To verify that you’ve actually got what you’ve been promised, let’s try to run the image:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></pre></td><td><pre><span><span>$</span><span> docker run --rm <span>"<span>$DOCKER_USER</span>/buildx-test:latest"</span></span></span><br><span>Unable to find image 'arturklauser/buildx-test:latest' locally</span><br><span>latest: Pulling from arturklauser/buildx-test</span><br><span>Digest: sha256:57ca2d778839da0b6287bcbc99fc2299b0cea29e5fe4cff8492a1ba6e62fc8c5</span><br><span>Status: Downloaded newer image for arturklauser/buildx-test:latest</span><br><span>Running on x86_64</span><br></pre></td></tr></tbody></table>

As expected, since we’re running on a 64-bit x86 host, the default architecture version that was used by docker was the _amd64_ which reports running on _x86\_64_. If you check the local image in docker it confirms that:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>$</span><span> docker inspect --format <span>"{{.Architecture}}"</span> <span>"<span>$DOCKER_USER</span>/buildx-test:latest"</span></span></span><br><span>amd64</span><br></pre></td></tr></tbody></table>

To pull and run a specific architecture version, use the image name including its full sha256 value that was reported by `imagetools`:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></pre></td><td><pre><span><span>$</span><span> docker run --rm <span>"<span>$DOCKER_USER</span>/buildx-test:latest@sha256:6ed2267dc7082fbfc4454805b94326418ad14c530879a7c9d6f02f0961e2899c"</span></span></span><br><span>Unable to find image 'arturklauser/buildx-test:latest@sha256:6ed2267dc7082fbfc4454805b94326418ad14c530879a7c9d6f02f0961e2899c' locally</span><br><span>sha256:6ed2267dc7082fbfc4454805b94326418ad14c530879a7c9d6f02f0961e2899c: Pulling from arturklauser/buildx-test</span><br><span>a5dee701e1e8: Pull complete </span><br><span>Digest: sha256:6ed2267dc7082fbfc4454805b94326418ad14c530879a7c9d6f02f0961e2899c</span><br><span>Status: Downloaded newer image for arturklauser/buildx-test@sha256:6ed2267dc7082fbfc4454805b94326418ad14c530879a7c9d6f02f0961e2899c</span><br><span>Running on ppc64le</span><br></pre></td></tr></tbody></table>

Since the sha256 value we requested here was that of the PowerPC image version, we see that the image is reporting to run on _ppc64le_ as expected.

Optionally, we can pull and run non-native image versions by platform name. For that though we need to turn on another experimental feature, this time in the docker engine, that’ll allow us to specify a `--platform`. If docker engine experimental features are not turned on you’ll get an error instead:

> “–platform” is only supported on a Docker daemon with experimental features enabled

Change the docker engine configuration file or create one if it doesn’t exist already:

/etc/docker/daemon.json

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></pre></td><td><pre><span>{</span><br><span>  ...</span><br><span>  <span>"experimental"</span> : <span>true</span></span><br><span>}</span><br></pre></td></tr></tbody></table>

After changing the configuration file you’ll also need to restart `dockerd` for the change to take effect:

<table><tbody><tr><td><pre><span>1</span><br></pre></td><td><pre><span><span>$</span><span> sudo systemctl restart docker</span></span><br></pre></td></tr></tbody></table>

Let’s purge the image that we’ve already pulled and try a different architecture:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></pre></td><td><pre><span><span>$</span><span> docker rmi <span>"<span>$DOCKER_USER</span>/buildx-test:latest"</span></span></span><br><span>Untagged: arturklauser/buildx-test:latest</span><br><span>Untagged: arturklauser/buildx-test@sha256:57ca2d778839da0b6287bcbc99fc2299b0cea29e5fe4cff8492a1ba6e62fc8c5</span><br><span><span></span></span><br><span><span>$</span><span> docker run --rm --platform linux/aarch64 <span>"<span>$DOCKER_USER</span>/buildx-test:latest"</span></span></span><br><span>Unable to find image 'arturklauser/buildx-test:latest' locally</span><br><span>latest: Pulling from arturklauser/buildx-test</span><br><span>cde5963f3b93: Pull complete </span><br><span>Digest: sha256:57ca2d778839da0b6287bcbc99fc2299b0cea29e5fe4cff8492a1ba6e62fc8c5</span><br><span>Status: Downloaded newer image for arturklauser/buildx-test:latest</span><br><span>Running on aarch64</span><br></pre></td></tr></tbody></table>

Now we see that the architecture version of the image we’ve pulled and run is the one for 64-bit ARM _aarch64_, as can also be verified by looking at the image metadata:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><span><span>$</span><span> docker inspect --format <span>"{{.Architecture}}"</span> <span>"<span>$DOCKER_USER</span>/buildx-test:latest"</span></span></span><br><span>arm64</span><br></pre></td></tr></tbody></table>

With this you’ve got to the point where you can start to build your own multi-architecture docker images with buildx.

Happy developing!

## [](https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/#Appendix "Appendix")Appendix

The following script shows how you can use what was described above to build multi-architecture docker images in CI/CD pipelines like Github Actions or Travis.

<table data-hpc="" data-tab-size="8" data-paste-markdown-skip="" data-tagsearch-lang="Shell" data-tagsearch-path="multi-arch-docker-ci.sh"><tbody><tr><td id="file-multi-arch-docker-ci-sh-L1" data-line-number="1"></td><td id="file-multi-arch-docker-ci-sh-LC1"><span><span>#!</span>/bin/bash</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L2" data-line-number="2"></td><td id="file-multi-arch-docker-ci-sh-LC2"><span><span>#</span> (c) 2020 Artur.Klauser@computer.org</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L3" data-line-number="3"></td><td id="file-multi-arch-docker-ci-sh-LC3"><span><span>#</span> SPDX-License-Identifier: Apache-2.0 OR MIT</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L4" data-line-number="4"></td><td id="file-multi-arch-docker-ci-sh-LC4"><span><span>#</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L5" data-line-number="5"></td><td id="file-multi-arch-docker-ci-sh-LC5"><span><span>#</span> This script installs support for building multi-architecture docker images</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L6" data-line-number="6"></td><td id="file-multi-arch-docker-ci-sh-LC6"><span><span>#</span> with docker buildx on CI/CD pipelines like Github Actions or Travis. It is</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L7" data-line-number="7"></td><td id="file-multi-arch-docker-ci-sh-LC7"><span><span>#</span> assumed that you start of with a fresh VM every time you run this and have to</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L8" data-line-number="8"></td><td id="file-multi-arch-docker-ci-sh-LC8"><span><span>#</span> install everything necessary to support 'docker buildx build' from scratch.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L9" data-line-number="9"></td><td id="file-multi-arch-docker-ci-sh-LC9"><span><span>#</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L10" data-line-number="10"></td><td id="file-multi-arch-docker-ci-sh-LC10"><span><span>#</span> Example usage in Travis stage:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L11" data-line-number="11"></td><td id="file-multi-arch-docker-ci-sh-LC11"><span><span>#</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L12" data-line-number="12"></td><td id="file-multi-arch-docker-ci-sh-LC12"><span><span>#</span> jobs:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L13" data-line-number="13"></td><td id="file-multi-arch-docker-ci-sh-LC13"><span><span>#</span> include:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L14" data-line-number="14"></td><td id="file-multi-arch-docker-ci-sh-LC14"><span><span>#</span> - stage: Deploy docker image</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L15" data-line-number="15"></td><td id="file-multi-arch-docker-ci-sh-LC15"><span><span>#</span> script:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L16" data-line-number="16"></td><td id="file-multi-arch-docker-ci-sh-LC16"><span><span>#</span> - source ./multi-arch-docker-ci.sh</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L17" data-line-number="17"></td><td id="file-multi-arch-docker-ci-sh-LC17"><span><span>#</span> - set -ex; multi_arch_docker::main; set +x</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L18" data-line-number="18"></td><td id="file-multi-arch-docker-ci-sh-LC18"><span><span>#</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L19" data-line-number="19"></td><td id="file-multi-arch-docker-ci-sh-LC19"><span><span>#</span> More information about Linux environment constraints can be found at:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L20" data-line-number="20"></td><td id="file-multi-arch-docker-ci-sh-LC20"><span><span>#</span> <a href="https://nexus.eddiesinentropy.net/2020/01/12/Building-Multi-architecture-Docker-Images-With-Buildx/" rel="nofollow"><span>https</span><span>://</span><span>nexus</span><span>.</span><span>eddiesinentropy</span><span>.</span><span>net</span><span>/</span><span>2020</span><span>/</span><span>01</span><span>/</span><span>12</span><span>/</span><span>Building</span><span>-</span><span>Multi</span><span>-</span><span>architecture</span><span>-</span><span>Docker</span><span>-</span><span>Images</span><span>-</span><span>With</span><span>-</span><span>Buildx</span><span>/</span></a></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L21" data-line-number="21"></td><td id="file-multi-arch-docker-ci-sh-LC21"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L22" data-line-number="22"></td><td id="file-multi-arch-docker-ci-sh-LC22"><span>function</span> <span>_version()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L23" data-line-number="23"></td><td id="file-multi-arch-docker-ci-sh-LC23"><span>printf</span> <span><span>'</span>%02d<span>'</span></span> <span><span>$(</span>echo <span><span>"</span><span>$1</span><span>"</span></span> <span>|</span> tr <span>.</span> <span><span>'</span> <span>'</span></span> <span>|</span> sed -e <span><span>'</span>s/ 0*/ /g<span>'</span></span><span>)</span></span> <span>2&gt;</span>/dev/null</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L24" data-line-number="24"></td><td id="file-multi-arch-docker-ci-sh-LC24">}</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L25" data-line-number="25"></td><td id="file-multi-arch-docker-ci-sh-LC25"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L26" data-line-number="26"></td><td id="file-multi-arch-docker-ci-sh-LC26"><span>function</span> <span>multi_arch_docker::install_docker_buildx()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L27" data-line-number="27"></td><td id="file-multi-arch-docker-ci-sh-LC27"><span><span>#</span> Check kernel version.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L28" data-line-number="28"></td><td id="file-multi-arch-docker-ci-sh-LC28"><span>local</span> -r kernel_version=<span><span>"</span><span><span>$(</span>uname -r<span>)</span></span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L29" data-line-number="29"></td><td id="file-multi-arch-docker-ci-sh-LC29"><span>if</span> [[ <span><span>"</span><span><span>$(</span>_version <span><span>"</span><span>$kernel_version</span><span>"</span></span><span>)</span></span><span>"</span></span> <span>&lt;</span> <span><span>"</span><span><span>$(</span>_version <span><span>'</span>4.8<span>'</span></span><span>)</span></span><span>"</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L30" data-line-number="30"></td><td id="file-multi-arch-docker-ci-sh-LC30"><span>echo</span> <span><span>"</span>Kernel <span>$kernel_version</span> too old - need &gt;= 4.8.<span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L31" data-line-number="31"></td><td id="file-multi-arch-docker-ci-sh-LC31"><span>exit</span> 1</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L32" data-line-number="32"></td><td id="file-multi-arch-docker-ci-sh-LC32"><span>fi</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L33" data-line-number="33"></td><td id="file-multi-arch-docker-ci-sh-LC33"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L34" data-line-number="34"></td><td id="file-multi-arch-docker-ci-sh-LC34"><span><span>#</span> Install up-to-date version of docker, with buildx support.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L35" data-line-number="35"></td><td id="file-multi-arch-docker-ci-sh-LC35"><span>local</span> -r docker_apt_repo=<span><span>'</span><a href="https://download.docker.com/linux/ubuntu" rel="nofollow"><span>https</span><span>://</span><span>download</span><span>.</span><span>docker</span><span>.</span><span>com</span><span>/</span><span>linux</span><span>/</span><span>ubuntu</span></a><span>'</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L36" data-line-number="36"></td><td id="file-multi-arch-docker-ci-sh-LC36">curl -fsSL <span><span>"</span><span>${docker_apt_repo}</span>/gpg<span>"</span></span> <span>|</span> sudo apt-key add -</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L37" data-line-number="37"></td><td id="file-multi-arch-docker-ci-sh-LC37"><span>local</span> -r os=<span><span>"</span><span><span>$(</span>lsb_release -cs<span>)</span></span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L38" data-line-number="38"></td><td id="file-multi-arch-docker-ci-sh-LC38">sudo add-apt-repository <span><span>"</span>deb [arch=amd64] <span>$docker_apt_repo</span> <span>$os</span> stable<span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L39" data-line-number="39"></td><td id="file-multi-arch-docker-ci-sh-LC39">sudo apt-get update</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L40" data-line-number="40"></td><td id="file-multi-arch-docker-ci-sh-LC40">sudo apt-get -y -o Dpkg::Options::=<span><span>"</span>--force-confnew<span>"</span></span> install docker-ce</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L41" data-line-number="41"></td><td id="file-multi-arch-docker-ci-sh-LC41"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L42" data-line-number="42"></td><td id="file-multi-arch-docker-ci-sh-LC42"><span><span>#</span> Enable docker daemon experimental support (for 'docker pull --platform').</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L43" data-line-number="43"></td><td id="file-multi-arch-docker-ci-sh-LC43"><span>local</span> -r config=<span><span>'</span>/etc/docker/daemon.json<span>'</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L44" data-line-number="44"></td><td id="file-multi-arch-docker-ci-sh-LC44"><span>if</span> [[ <span>-e</span> <span><span>"</span><span>$config</span><span>"</span></span> ]]<span>;</span> <span>then</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L45" data-line-number="45"></td><td id="file-multi-arch-docker-ci-sh-LC45">sudo sed -i -e <span><span>'</span>s/{/{ "experimental": true, /<span>'</span></span> <span><span>"</span><span>$config</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L46" data-line-number="46"></td><td id="file-multi-arch-docker-ci-sh-LC46"><span>else</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L47" data-line-number="47"></td><td id="file-multi-arch-docker-ci-sh-LC47"><span>echo</span> <span><span>'</span>{ "experimental": true }<span>'</span></span> <span>|</span> sudo tee <span><span>"</span><span>$config</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L48" data-line-number="48"></td><td id="file-multi-arch-docker-ci-sh-LC48"><span>fi</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L49" data-line-number="49"></td><td id="file-multi-arch-docker-ci-sh-LC49">sudo systemctl restart docker</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L50" data-line-number="50"></td><td id="file-multi-arch-docker-ci-sh-LC50"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L51" data-line-number="51"></td><td id="file-multi-arch-docker-ci-sh-LC51"><span><span>#</span> Install QEMU multi-architecture support for docker buildx.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L52" data-line-number="52"></td><td id="file-multi-arch-docker-ci-sh-LC52">docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L53" data-line-number="53"></td><td id="file-multi-arch-docker-ci-sh-LC53"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L54" data-line-number="54"></td><td id="file-multi-arch-docker-ci-sh-LC54"><span><span>#</span> Enable docker CLI experimental support (for 'docker buildx').</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L55" data-line-number="55"></td><td id="file-multi-arch-docker-ci-sh-LC55"><span>export</span> DOCKER_CLI_EXPERIMENTAL=enabled</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L56" data-line-number="56"></td><td id="file-multi-arch-docker-ci-sh-LC56"><span><span>#</span> Instantiate docker buildx builder with multi-architecture support.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L57" data-line-number="57"></td><td id="file-multi-arch-docker-ci-sh-LC57">docker buildx create --name mybuilder</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L58" data-line-number="58"></td><td id="file-multi-arch-docker-ci-sh-LC58">docker buildx use mybuilder</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L59" data-line-number="59"></td><td id="file-multi-arch-docker-ci-sh-LC59"><span><span>#</span> Start up buildx and verify that all is OK.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L60" data-line-number="60"></td><td id="file-multi-arch-docker-ci-sh-LC60">docker buildx inspect --bootstrap</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L61" data-line-number="61"></td><td id="file-multi-arch-docker-ci-sh-LC61">}</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L62" data-line-number="62"></td><td id="file-multi-arch-docker-ci-sh-LC62"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L63" data-line-number="63"></td><td id="file-multi-arch-docker-ci-sh-LC63"><span><span>#</span> Log in to Docker Hub for deployment.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L64" data-line-number="64"></td><td id="file-multi-arch-docker-ci-sh-LC64"><span><span>#</span> Env:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L65" data-line-number="65"></td><td id="file-multi-arch-docker-ci-sh-LC65"><span><span>#</span> DOCKER_USERNAME ... user name of Docker Hub account</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L66" data-line-number="66"></td><td id="file-multi-arch-docker-ci-sh-LC66"><span><span>#</span> DOCKER_PASSWORD ... password of Docker Hub account</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L67" data-line-number="67"></td><td id="file-multi-arch-docker-ci-sh-LC67"><span>function</span> <span>multi_arch_docker::login_to_docker_hub()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L68" data-line-number="68"></td><td id="file-multi-arch-docker-ci-sh-LC68"><span>echo</span> <span><span>"</span><span>$DOCKER_PASSWORD</span><span>"</span></span> <span>|</span> docker login -u=<span><span>"</span><span>$DOCKER_USERNAME</span><span>"</span></span> --password-stdin</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L69" data-line-number="69"></td><td id="file-multi-arch-docker-ci-sh-LC69">}</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L70" data-line-number="70"></td><td id="file-multi-arch-docker-ci-sh-LC70"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L71" data-line-number="71"></td><td id="file-multi-arch-docker-ci-sh-LC71"><span><span>#</span> Run buildx build and push.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L72" data-line-number="72"></td><td id="file-multi-arch-docker-ci-sh-LC72"><span><span>#</span> Env:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L73" data-line-number="73"></td><td id="file-multi-arch-docker-ci-sh-LC73"><span><span>#</span> DOCKER_PLATFORMS ... space separated list of Docker platforms to build.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L74" data-line-number="74"></td><td id="file-multi-arch-docker-ci-sh-LC74"><span><span>#</span> Args:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L75" data-line-number="75"></td><td id="file-multi-arch-docker-ci-sh-LC75"><span><span>#</span> Optional additional arguments for 'docker buildx build'.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L76" data-line-number="76"></td><td id="file-multi-arch-docker-ci-sh-LC76"><span>function</span> <span>multi_arch_docker::buildx()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L77" data-line-number="77"></td><td id="file-multi-arch-docker-ci-sh-LC77">docker buildx build \</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L78" data-line-number="78"></td><td id="file-multi-arch-docker-ci-sh-LC78">--platform <span><span>"</span><span>${DOCKER_PLATFORMS<span>//</span> <span>/</span>,}</span><span>"</span></span> \</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L79" data-line-number="79"></td><td id="file-multi-arch-docker-ci-sh-LC79">--push \</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L80" data-line-number="80"></td><td id="file-multi-arch-docker-ci-sh-LC80">--progress plain \</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L81" data-line-number="81"></td><td id="file-multi-arch-docker-ci-sh-LC81">-f Dockerfile.multi-arch \</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L82" data-line-number="82"></td><td id="file-multi-arch-docker-ci-sh-LC82"><span><span>"</span><span>$@</span><span>"</span></span> \</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L83" data-line-number="83"></td><td id="file-multi-arch-docker-ci-sh-LC83"><span>.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L84" data-line-number="84"></td><td id="file-multi-arch-docker-ci-sh-LC84">}</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L85" data-line-number="85"></td><td id="file-multi-arch-docker-ci-sh-LC85"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L86" data-line-number="86"></td><td id="file-multi-arch-docker-ci-sh-LC86"><span><span>#</span> Build and push docker images for all tags.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L87" data-line-number="87"></td><td id="file-multi-arch-docker-ci-sh-LC87"><span><span>#</span> Env:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L88" data-line-number="88"></td><td id="file-multi-arch-docker-ci-sh-LC88"><span><span>#</span> DOCKER_PLATFORMS ... space separated list of Docker platforms to build.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L89" data-line-number="89"></td><td id="file-multi-arch-docker-ci-sh-LC89"><span><span>#</span> DOCKER_BASE ........ docker image base name to build</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L90" data-line-number="90"></td><td id="file-multi-arch-docker-ci-sh-LC90"><span><span>#</span> TAGS ............... space separated list of docker image tags to build.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L91" data-line-number="91"></td><td id="file-multi-arch-docker-ci-sh-LC91"><span>function</span> <span>multi_arch_docker::build_and_push_all()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L92" data-line-number="92"></td><td id="file-multi-arch-docker-ci-sh-LC92"><span>for</span> <span>tag</span> <span>in</span> <span>$TAGS</span><span>;</span> <span>do</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L93" data-line-number="93"></td><td id="file-multi-arch-docker-ci-sh-LC93">multi_arch_docker::buildx -t <span><span>"</span><span>$DOCKER_BASE</span>:<span>$tag</span><span>"</span></span> <span>&lt;</span>your-arguments-here<span>&gt;</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L94" data-line-number="94"></td><td id="file-multi-arch-docker-ci-sh-LC94"><span>done</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L95" data-line-number="95"></td><td id="file-multi-arch-docker-ci-sh-LC95">}</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L96" data-line-number="96"></td><td id="file-multi-arch-docker-ci-sh-LC96"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L97" data-line-number="97"></td><td id="file-multi-arch-docker-ci-sh-LC97"><span><span>#</span> Test all pushed docker images.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L98" data-line-number="98"></td><td id="file-multi-arch-docker-ci-sh-LC98"><span><span>#</span> Env:</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L99" data-line-number="99"></td><td id="file-multi-arch-docker-ci-sh-LC99"><span><span>#</span> DOCKER_PLATFORMS ... space separated list of Docker platforms to test.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L100" data-line-number="100"></td><td id="file-multi-arch-docker-ci-sh-LC100"><span><span>#</span> DOCKER_BASE ........ docker image base name to test</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L101" data-line-number="101"></td><td id="file-multi-arch-docker-ci-sh-LC101"><span><span>#</span> TAGS ............... space separated list of docker image tags to test.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L102" data-line-number="102"></td><td id="file-multi-arch-docker-ci-sh-LC102"><span>function</span> <span>multi_arch_docker::test_all()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L103" data-line-number="103"></td><td id="file-multi-arch-docker-ci-sh-LC103"><span>for</span> <span>platform</span> <span>in</span> <span>$DOCKER_PLATFORMS</span><span>;</span> <span>do</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L104" data-line-number="104"></td><td id="file-multi-arch-docker-ci-sh-LC104"><span>for</span> <span>tag</span> <span>in</span> <span>$TAGS</span><span>;</span> <span>do</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L105" data-line-number="105"></td><td id="file-multi-arch-docker-ci-sh-LC105">image=<span><span>"</span><span>${DOCKER_BASE}</span>:<span>${tag}</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L106" data-line-number="106"></td><td id="file-multi-arch-docker-ci-sh-LC106">msg=<span><span>"</span>Testing docker image <span>$image</span> on platform <span>$platform</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L107" data-line-number="107"></td><td id="file-multi-arch-docker-ci-sh-LC107">line=<span><span>"</span><span>${msg<span>//</span>?<span>/</span>=}</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L108" data-line-number="108"></td><td id="file-multi-arch-docker-ci-sh-LC108"><span>printf</span> <span><span>'</span>\n%s\n%s\n%s\n<span>'</span></span> <span><span>"</span><span>${line}</span><span>"</span></span> <span><span>"</span><span>${msg}</span><span>"</span></span> <span><span>"</span><span>${line}</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L109" data-line-number="109"></td><td id="file-multi-arch-docker-ci-sh-LC109">docker pull -q --platform <span><span>"</span><span>$platform</span><span>"</span></span> <span><span>"</span><span>$image</span><span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L110" data-line-number="110"></td><td id="file-multi-arch-docker-ci-sh-LC110"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L111" data-line-number="111"></td><td id="file-multi-arch-docker-ci-sh-LC111"><span>echo</span> -n <span><span>"</span>Image architecture: <span>"</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L112" data-line-number="112"></td><td id="file-multi-arch-docker-ci-sh-LC112">docker run --rm --entrypoint /bin/sh <span><span>"</span><span>$image</span><span>"</span></span> -c <span><span>'</span>uname -m<span>'</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L113" data-line-number="113"></td><td id="file-multi-arch-docker-ci-sh-LC113"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L114" data-line-number="114"></td><td id="file-multi-arch-docker-ci-sh-LC114"><span><span>#</span> Run your test on the built image.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L115" data-line-number="115"></td><td id="file-multi-arch-docker-ci-sh-LC115">docker run --rm -v <span><span>"</span><span>$PWD</span>:/mnt<span>"</span></span> -w /mnt <span><span>"</span><span>$image</span><span>"</span></span> <span>&lt;</span>your-arguments-here<span>&gt;</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L116" data-line-number="116"></td><td id="file-multi-arch-docker-ci-sh-LC116"><span>done</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L117" data-line-number="117"></td><td id="file-multi-arch-docker-ci-sh-LC117"><span>done</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L118" data-line-number="118"></td><td id="file-multi-arch-docker-ci-sh-LC118">}</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L119" data-line-number="119"></td><td id="file-multi-arch-docker-ci-sh-LC119"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L120" data-line-number="120"></td><td id="file-multi-arch-docker-ci-sh-LC120"><span>function</span> <span>multi_arch_docker::main()</span> {</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L121" data-line-number="121"></td><td id="file-multi-arch-docker-ci-sh-LC121"><span><span>#</span> Set docker platforms for which to build.</span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L122" data-line-number="122"></td><td id="file-multi-arch-docker-ci-sh-LC122"><span>export</span> DOCKER_PLATFORMS=<span><span>'</span>linux/amd64<span>'</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L123" data-line-number="123"></td><td id="file-multi-arch-docker-ci-sh-LC123">DOCKER_PLATFORMS+=<span><span>'</span> linux/arm64<span>'</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L124" data-line-number="124"></td><td id="file-multi-arch-docker-ci-sh-LC124">DOCKER_PLATFORMS+=<span><span>'</span> linux/arm/v6<span>'</span></span></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L125" data-line-number="125"></td><td id="file-multi-arch-docker-ci-sh-LC125"></td></tr><tr><td id="file-multi-arch-docker-ci-sh-L126" data-line-number="126"></td><td id="file-multi-arch-docker-ci-sh-LC126">multi_arch_docker::install_docker_buildx</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L127" data-line-number="127"></td><td id="file-multi-arch-docker-ci-sh-LC127">multi_arch_docker::login_to_docker_hub</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L128" data-line-number="128"></td><td id="file-multi-arch-docker-ci-sh-LC128">multi_arch_docker::build_and_push_all</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L129" data-line-number="129"></td><td id="file-multi-arch-docker-ci-sh-LC129"><span>set</span> +x</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L130" data-line-number="130"></td><td id="file-multi-arch-docker-ci-sh-LC130">multi_arch_docker::test_all</td></tr><tr><td id="file-multi-arch-docker-ci-sh-L131" data-line-number="131"></td><td id="file-multi-arch-docker-ci-sh-LC131">}</td></tr></tbody></table>